---
/**
 * WorkflowDiagram Component
 * Pure HTML/CSS implementation with interactive philosophy navigation.
 * No SVG - uses positioned divs for markers, additions, and center content.
 */

interface EventMarker {
  id: string;
  edge: "top" | "right" | "bottom" | "left";
  position: number; // 0-1 percentage along the edge
  label: string;
  tooltip: string;
}

interface Addition {
  id: string;
  event: string; // matches EventMarker.id
  type: string;
  label: string;
  description: string;
  effect: string;
}

interface Philosophy {
  id: string;
  title: string;
  additions: Addition[];
  highlight: {
    type: string;
    title: string;
    content: string;
    comparison?: {
      before_label: string;
      before: string;
      after_label: string;
      after: string;
    };
  };
  relatedEvents?: string[];
  relatedSkills: string[];
}

interface DiagramData {
  diagram: {
    events: EventMarker[];
    rect: { width: number; height: number; rx: number };
  };
  philosophies: Philosophy[];
}

interface Props {
  diagramData: DiagramData;
}

const { diagramData } = Astro.props;
const { diagram, philosophies } = diagramData;

// First philosophy is the default
const defaultId = philosophies.length > 0 ? philosophies[0].id : "";

// Build events map: philosophy id -> all related event ids (from relatedEvents + additions)
const eventsMap: Record<string, string[]> = {};
philosophies.forEach((phil) => {
  const events = new Set<string>(phil.relatedEvents || []);
  phil.additions.forEach((add) => events.add(add.event));
  eventsMap[phil.id] = Array.from(events);
});

// Helper to get edge color variables
function getEdgeColor(edge: string): { main: string; soft: string } {
  switch (edge) {
    case "top":
      return { main: "var(--color-accent)", soft: "var(--color-accent-soft)" };
    case "right":
      return { main: "var(--color-secondary)", soft: "var(--color-secondary-soft)" };
    case "bottom":
      return { main: "var(--color-earth-400)", soft: "var(--color-earth-100)" };
    case "left":
      return { main: "var(--color-text-muted)", soft: "rgba(122, 111, 96, 0.12)" };
    default:
      return { main: "var(--color-text)", soft: "var(--color-earth-100)" };
  }
}
---

<section class="workflow-diagram" data-workflow-diagram>
  <header>
    <h2>Design Philosophy</h2>
  </header>

  {/* Philosophy navigation pills */}
  {philosophies.length > 1 && (
    <nav class="philosophy-nav" aria-label="Design philosophy topics">
      {philosophies.map((phil) => (
        <button
          class:list={["philosophy-nav-btn", { "is-active": phil.id === defaultId }]}
          data-philosophy-btn={phil.id}
          type="button"
          aria-pressed={phil.id === defaultId ? "true" : "false"}
        >
          {phil.title}
        </button>
      ))}
    </nav>
  )}

  <div class="workflow-rect-wrapper">
    <div class="workflow-rect" data-workflow-rect>
      {/* Edge markers */}
      {diagram.events.map((event) => {
        const colors = getEdgeColor(event.edge);
        return (
          <div
            class={`edge-marker edge-${event.edge}`}
            data-event={event.id}
            data-edge={event.edge}
            style={`--marker-position: ${event.position * 100}%; --marker-color: ${colors.main}; --marker-color-soft: ${colors.soft};`}
            title={event.tooltip}
          >
            <div class="marker-circle">
              <div class="marker-dot"></div>
            </div>
            <div class="marker-label">{event.label}</div>
          </div>
        );
      })}

      {/* Addition callouts */}
      {philosophies.map((phil) =>
        phil.additions.map((addition) => {
          const event = diagram.events.find((e) => e.id === addition.event);
          if (!event) return null;
          const colors = getEdgeColor(event.edge);
          return (
            <div
              class={`addition-callout addition-${event.edge}`}
              data-philosophy={phil.id}
              data-addition={addition.id}
              style={`--addition-position: ${event.position * 100}%; --addition-color: ${colors.main}; --addition-color-soft: ${colors.soft};`}
              title={`${addition.description} — ${addition.effect}`}
            >
              {addition.label}
            </div>
          );
        })
      )}

      {/* Center content area */}
      <div class="center-content">
        {philosophies.map((phil) => (
          <div
            class:list={["highlight-panel", { "is-active": phil.id === defaultId }]}
            data-philosophy={phil.id}
          >
            <h4 class="highlight-title">{phil.highlight.title}</h4>
            <p class="highlight-content">{phil.highlight.content}</p>
            {phil.highlight.comparison && (
              <div class="highlight-comparison">
                <div class="comparison-item">
                  <div class="comparison-label">{phil.highlight.comparison.before_label}</div>
                  <div class="comparison-text">{phil.highlight.comparison.before}</div>
                </div>
                <div class="comparison-arrow">→</div>
                <div class="comparison-item">
                  <div class="comparison-label">{phil.highlight.comparison.after_label}</div>
                  <div class="comparison-text">{phil.highlight.comparison.after}</div>
                </div>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  </div>

  {/* Embedded mapping of philosophy IDs to related event IDs for the script */}
  <script
    type="application/json"
    data-philosophy-events
    set:html={JSON.stringify(eventsMap)}
  />
</section>

<script>
  function initWorkflowDiagram() {
    const diagrams = document.querySelectorAll<HTMLElement>("[data-workflow-diagram]");

    diagrams.forEach((diagram) => {
      const buttons = diagram.querySelectorAll<HTMLButtonElement>("[data-philosophy-btn]");
      const rect = diagram.querySelector<HTMLElement>("[data-workflow-rect]");
      const markers = diagram.querySelectorAll<HTMLElement>("[data-event]");
      const additions = diagram.querySelectorAll<HTMLElement>("[data-addition]");
      const panels = diagram.querySelectorAll<HTMLElement>(".highlight-panel");

      if (!buttons.length || !panels.length || !rect) return;

      // Read embedded JSON mappings
      const mappingEl = diagram.querySelector<HTMLScriptElement>("[data-philosophy-events]");
      let eventsMap: Record<string, string[]> = {};
      if (mappingEl) {
        try {
          eventsMap = JSON.parse(mappingEl.textContent || "{}");
        } catch {
          eventsMap = {};
        }
      }

      function activate(philId: string) {
        // Toggle buttons
        buttons.forEach((btn) => {
          const active = btn.dataset.philosophyBtn === philId;
          btn.classList.toggle("is-active", active);
          btn.setAttribute("aria-pressed", active ? "true" : "false");
        });

        // Toggle markers
        const relatedEvents = eventsMap[philId] || [];
        rect.classList.toggle("has-highlight", relatedEvents.length > 0);
        markers.forEach((m) => {
          m.classList.toggle("is-highlighted", relatedEvents.includes(m.dataset.event || ""));
        });

        // Toggle additions
        additions.forEach((a) => {
          a.classList.toggle("is-active", a.dataset.philosophy === philId);
        });

        // Toggle panels
        panels.forEach((p) => {
          p.classList.toggle("is-active", p.dataset.philosophy === philId);
        });
      }

      // Button click handlers
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const philosophyId = btn.dataset.philosophyBtn;
          if (philosophyId) activate(philosophyId);
        });
      });

      // Initial state
      if (buttons[0]?.dataset.philosophyBtn) {
        activate(buttons[0].dataset.philosophyBtn);
      }
    });
  }

  // Run on initial load and on Astro page transitions
  document.addEventListener("astro:page-load", initWorkflowDiagram);
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initWorkflowDiagram);
  } else {
    initWorkflowDiagram();
  }
</script>

<style>
  /* ---- Section Container ---- */
  .workflow-diagram {
    margin-bottom: var(--space-16);
  }

  .workflow-diagram > header {
    padding-left: var(--space-6);
    margin-bottom: var(--space-6);
  }

  .workflow-diagram h2 {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: 600;
    color: var(--color-text);
    line-height: var(--leading-snug);
  }

  /* ---- Navigation Pills ---- */
  .philosophy-nav {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    padding-left: var(--space-6);
    margin-bottom: var(--space-8);
  }

  /* Hide nav without JS */
  :global(.no-js) .philosophy-nav {
    display: none;
  }

  .philosophy-nav-btn {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-muted);
    background: var(--color-earth-100);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    padding: var(--space-2) var(--space-5);
    cursor: pointer;
    transition:
      color var(--transition-fast),
      background var(--transition-fast),
      border-color var(--transition-fast),
      box-shadow var(--transition-fast);
    white-space: nowrap;
  }

  .philosophy-nav-btn:hover {
    color: var(--color-text-secondary);
    border-color: var(--color-earth-300);
    background: var(--color-earth-200);
  }

  .philosophy-nav-btn.is-active {
    color: var(--color-surface);
    background: var(--color-accent);
    border-color: var(--color-accent);
    box-shadow: var(--shadow-sm);
  }

  .philosophy-nav-btn.is-active:hover {
    background: var(--color-accent-hover);
    border-color: var(--color-accent-hover);
  }

  .philosophy-nav-btn:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* ---- Rectangle Wrapper ---- */
  .workflow-rect-wrapper {
    padding: var(--space-12) var(--space-10);
  }

  /* ---- The Rectangle ---- */
  .workflow-rect {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    background: var(--color-surface);
    border: 1.5px solid var(--color-earth-300);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-sm);
  }

  /* ---- Edge Markers ---- */
  .edge-marker {
    position: absolute;
    transition:
      opacity var(--transition-base);
  }

  /* Top edge */
  .edge-marker.edge-top {
    left: var(--marker-position);
    top: 0;
    transform: translate(-50%, -50%);
  }

  .edge-marker.edge-top .marker-label {
    position: absolute;
    top: -28px;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
  }

  /* Right edge */
  .edge-marker.edge-right {
    right: 0;
    top: var(--marker-position);
    transform: translate(50%, -50%);
  }

  .edge-marker.edge-right .marker-label {
    position: absolute;
    left: 28px;
    top: 50%;
    transform: translateY(-50%);
    white-space: nowrap;
  }

  /* Bottom edge */
  .edge-marker.edge-bottom {
    left: var(--marker-position);
    bottom: 0;
    transform: translate(-50%, 50%);
  }

  .edge-marker.edge-bottom .marker-label {
    position: absolute;
    bottom: -28px;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
  }

  /* Left edge */
  .edge-marker.edge-left {
    left: 0;
    top: var(--marker-position);
    transform: translate(-50%, -50%);
  }

  .edge-marker.edge-left .marker-label {
    position: absolute;
    right: 28px;
    top: 50%;
    transform: translateY(-50%);
    white-space: nowrap;
  }

  /* Marker circle */
  .marker-circle {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid var(--marker-color);
    background: var(--color-surface);
    display: flex;
    align-items: center;
    justify-content: center;
    transition:
      background var(--transition-base),
      box-shadow var(--transition-base);
  }

  .marker-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--color-surface);
    transition: background var(--transition-base);
  }

  /* Marker label */
  .marker-label {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-muted);
    transition: color var(--transition-base);
  }

  /* Highlighted state */
  .edge-marker.is-highlighted .marker-circle {
    background: var(--marker-color);
    box-shadow: 0 0 12px var(--marker-color-soft);
  }

  .edge-marker.is-highlighted .marker-dot {
    background: var(--color-surface);
  }

  .edge-marker.is-highlighted .marker-label {
    color: var(--marker-color);
  }

  /* All markers remain fully visible; highlighted ones get emphasis via bold border */

  /* ---- Addition Callouts ---- */
  .addition-callout {
    position: absolute;
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--addition-color);
    background: var(--addition-color-soft);
    border: 1px solid var(--addition-color);
    border-radius: var(--radius-full);
    padding: var(--space-2) var(--space-4);
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition:
      opacity var(--transition-base),
      transform var(--transition-base),
      box-shadow var(--transition-fast);
  }

  .addition-callout.is-active {
    opacity: 1;
    pointer-events: auto;
  }

  .addition-callout.is-active:hover {
    box-shadow: 0 3px 10px var(--addition-color-soft);
  }

  /* Top edge additions - position inward from top */
  .addition-callout.addition-top {
    left: var(--addition-position);
    top: 40px;
    transform: translateX(-50%) translateY(-8px);
  }

  .addition-callout.addition-top.is-active {
    transform: translateX(-50%) translateY(0);
  }

  .addition-callout.addition-top.is-active:hover {
    transform: translateX(-50%) translateY(0) scale(1.06) rotate(-1deg);
  }

  /* Right edge additions - position inward from right */
  .addition-callout.addition-right {
    right: 40px;
    top: var(--addition-position);
    transform: translateY(-50%) translateX(8px);
  }

  .addition-callout.addition-right.is-active {
    transform: translateY(-50%) translateX(0);
  }

  .addition-callout.addition-right.is-active:hover {
    transform: translateY(-50%) translateX(0) scale(1.06) rotate(1deg);
  }

  /* Bottom edge additions - position inward from bottom */
  .addition-callout.addition-bottom {
    left: var(--addition-position);
    bottom: 40px;
    transform: translateX(-50%) translateY(8px);
  }

  .addition-callout.addition-bottom.is-active {
    transform: translateX(-50%) translateY(0);
  }

  .addition-callout.addition-bottom.is-active:hover {
    transform: translateX(-50%) translateY(0) scale(1.06) rotate(1deg);
  }

  /* Left edge additions - position inward from left */
  .addition-callout.addition-left {
    left: 40px;
    top: var(--addition-position);
    transform: translateY(-50%) translateX(-8px);
  }

  .addition-callout.addition-left.is-active {
    transform: translateY(-50%) translateX(0);
  }

  .addition-callout.addition-left.is-active:hover {
    transform: translateY(-50%) translateX(0) scale(1.06) rotate(-1deg);
  }

  /* ---- Center Content ---- */
  .center-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60%;
    max-width: 500px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .highlight-panel {
    display: none;
    background: rgba(255, 253, 249, 0.92);
    border: 1px solid var(--color-earth-200);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
    text-align: center;
  }

  .highlight-panel.is-active {
    display: block;
    animation: fadeIn var(--transition-base) ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .highlight-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-3);
    line-height: var(--leading-tight);
  }

  .highlight-content {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
    margin-bottom: 0;
  }

  /* ---- Comparison Layout ---- */
  .highlight-comparison {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: var(--space-4);
    align-items: center;
    margin-top: var(--space-4);
  }

  .comparison-item {
    text-align: center;
  }

  .comparison-label {
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
  }

  .comparison-text {
    font-family: var(--font-body);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
    background: var(--color-earth-50);
    border: 1px solid var(--color-earth-200);
    border-radius: var(--radius-md);
    padding: var(--space-3);
  }

  .comparison-arrow {
    font-size: var(--text-xl);
    color: var(--color-accent);
    font-weight: 600;
  }

  /* ---- Responsive: Mobile ---- */
  @media (max-width: 768px) {
    .workflow-diagram > header {
      padding-left: var(--space-4);
    }

    .workflow-diagram h2 {
      font-size: var(--text-2xl);
    }

    .philosophy-nav {
      padding-left: var(--space-4);
      gap: var(--space-2);
      margin-bottom: var(--space-6);
    }

    .philosophy-nav-btn {
      font-size: var(--text-xs);
      padding: var(--space-1) var(--space-3);
    }

    .workflow-rect-wrapper {
      padding: var(--space-8) var(--space-4);
    }

    .workflow-rect {
      aspect-ratio: auto;
      min-height: 400px;
    }

    .marker-label {
      font-size: var(--text-xs);
    }

    .center-content {
      width: 80%;
    }

    .highlight-title {
      font-size: var(--text-base);
    }

    .highlight-content {
      font-size: var(--text-xs);
    }

    .highlight-comparison {
      grid-template-columns: 1fr;
      gap: var(--space-2);
    }

    .comparison-arrow {
      transform: rotate(90deg);
    }
  }

  /* ---- No-JS Fallback ---- */
  :global(.no-js) .highlight-panel:first-child {
    display: block;
  }

  :global(.no-js) .addition-callout {
    display: none;
  }
</style>
