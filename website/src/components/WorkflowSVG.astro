---
/**
 * WorkflowSVG Component
 * Renders an SVG rounded rectangle with event markers on edges.
 * Each marker is a circle with a label positioned outside the rectangle.
 */

interface EventMarker {
  id: string;
  edge: "top" | "right" | "bottom" | "left";
  position: number;
  label: string;
  tooltip: string;
}

interface Props {
  events: EventMarker[];
  rect: { width: number; height: number; rx: number };
}

const { events, rect } = Astro.props;

// Padding to accommodate labels outside the rectangle
const padding = { top: 56, right: 120, bottom: 56, left: 120 };
const markerRadius = 7;

const svgWidth = rect.width + padding.left + padding.right;
const svgHeight = rect.height + padding.top + padding.bottom;

// Compute marker positions on the rectangle perimeter
function getMarkerPosition(edge: string, position: number) {
  const x0 = padding.left;
  const y0 = padding.top;

  switch (edge) {
    case "top":
      return { cx: x0 + position * rect.width, cy: y0 };
    case "right":
      return { cx: x0 + rect.width, cy: y0 + position * rect.height };
    case "bottom":
      return { cx: x0 + position * rect.width, cy: y0 + rect.height };
    case "left":
      return { cx: x0, cy: y0 + position * rect.height };
    default:
      return { cx: x0, cy: y0 };
  }
}

// Compute label anchor and offset based on edge
function getLabelAttrs(edge: string, cx: number, cy: number) {
  const offset = 18;
  switch (edge) {
    case "top":
      return { x: cx, y: cy - offset, textAnchor: "middle", dominantBaseline: "auto" };
    case "right":
      return { x: cx + offset, y: cy, textAnchor: "start", dominantBaseline: "central" };
    case "bottom":
      return { x: cx, y: cy + offset, textAnchor: "middle", dominantBaseline: "hanging" };
    case "left":
      return { x: cx - offset, y: cy, textAnchor: "end", dominantBaseline: "central" };
    default:
      return { x: cx, y: cy - offset, textAnchor: "middle", dominantBaseline: "auto" };
  }
}

// Edge-based color tokens (CSS custom properties applied via class)
function getEdgeClass(edge: string) {
  switch (edge) {
    case "top": return "marker-top";
    case "right": return "marker-right";
    case "bottom": return "marker-bottom";
    case "left": return "marker-left";
    default: return "marker-top";
  }
}
---

<svg
  class="workflow-svg"
  viewBox={`0 0 ${svgWidth} ${svgHeight}`}
  xmlns="http://www.w3.org/2000/svg"
  role="img"
  aria-label="Workflow diagram showing event markers on a process rectangle"
>
  <defs>
    <!-- Arrow marker for potential connector lines -->
    <marker
      id="workflow-arrow"
      viewBox="0 0 10 10"
      refX="8"
      refY="5"
      markerWidth="6"
      markerHeight="6"
      orient="auto-start-reverse"
    >
      <path d="M 0 0 L 10 5 L 0 10 z" class="arrow-fill" />
    </marker>

    <!-- Highlight gradient for active markers -->
    <radialGradient id="highlight-glow" cx="50%" cy="50%" r="50%">
      <stop offset="0%" stop-color="var(--color-accent)" stop-opacity="0.4" />
      <stop offset="100%" stop-color="var(--color-accent)" stop-opacity="0" />
    </radialGradient>

    <!-- Subtle gradient for the rectangle fill -->
    <linearGradient id="rect-fill-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="var(--color-surface)" />
      <stop offset="100%" stop-color="var(--color-earth-100)" />
    </linearGradient>
  </defs>

  <!-- Main rounded rectangle -->
  <rect
    class="workflow-rect"
    x={padding.left}
    y={padding.top}
    width={rect.width}
    height={rect.height}
    rx={rect.rx}
    ry={rect.rx}
  />

  <!-- Event markers -->
  {events.map((event) => {
    const { cx, cy } = getMarkerPosition(event.edge, event.position);
    const labelAttrs = getLabelAttrs(event.edge, cx, cy);
    const edgeClass = getEdgeClass(event.edge);

    return (
      <g
        class={`event-marker ${edgeClass}`}
        data-event={event.id}
        role="button"
        tabindex="0"
        aria-label={event.tooltip}
      >
        {/* Highlight glow ring (visible when .is-highlighted) */}
        <circle
          class="marker-glow"
          cx={cx}
          cy={cy}
          r={markerRadius + 8}
          fill="url(#highlight-glow)"
        />

        {/* Marker circle */}
        <circle
          class="marker-circle"
          cx={cx}
          cy={cy}
          r={markerRadius}
        />

        {/* Inner dot */}
        <circle
          class="marker-dot"
          cx={cx}
          cy={cy}
          r={3}
        />

        {/* Label text */}
        <text
          class="marker-label"
          x={labelAttrs.x}
          y={labelAttrs.y}
          text-anchor={labelAttrs.textAnchor}
          dominant-baseline={labelAttrs.dominantBaseline}
        >
          {event.label}
        </text>

        {/* Tooltip (SVG title element) */}
        <title>{event.tooltip}</title>
      </g>
    );
  })}
</svg>

<style>
  .workflow-svg {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Main rectangle */
  .workflow-rect {
    fill: url(#rect-fill-gradient);
    stroke: var(--color-earth-300);
    stroke-width: 1.5;
    transition: stroke var(--transition-base);
  }

  /* Arrow marker fill */
  .arrow-fill {
    fill: var(--color-earth-400);
  }

  /* ---- Event Marker Base ---- */
  .event-marker {
    cursor: pointer;
    outline: none;
  }

  .event-marker:focus-visible .marker-circle {
    stroke-width: 3;
  }

  .marker-glow {
    opacity: 0;
    transition: opacity var(--transition-base);
    pointer-events: none;
  }

  .marker-circle {
    stroke-width: 2;
    transition:
      fill var(--transition-base),
      stroke var(--transition-base),
      r var(--transition-base);
  }

  .marker-dot {
    fill: var(--color-surface);
    pointer-events: none;
    transition: fill var(--transition-base);
  }

  .marker-label {
    font-family: var(--font-body);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.02em;
    fill: var(--color-text-muted);
    pointer-events: none;
    transition: fill var(--transition-base);
  }

  /* ---- Edge Color Coding ---- */

  /* Top edge — Terracotta accent */
  .marker-top .marker-circle {
    fill: var(--color-accent-soft);
    stroke: var(--color-accent);
  }

  /* Right edge — Sage green */
  .marker-right .marker-circle {
    fill: var(--color-secondary-soft);
    stroke: var(--color-secondary);
  }

  /* Bottom edge — Earth warm taupe */
  .marker-bottom .marker-circle {
    fill: var(--color-earth-100);
    stroke: var(--color-earth-400);
  }

  /* Left edge — Muted brown */
  .marker-left .marker-circle {
    fill: rgba(122, 111, 96, 0.12);
    stroke: var(--color-text-muted);
  }

  /* ---- Hover State ---- */
  .event-marker:hover .marker-circle {
    filter: brightness(0.95);
  }

  .event-marker:hover .marker-label {
    fill: var(--color-text);
  }

  /* ---- Highlighted State ---- */
  .event-marker.is-highlighted .marker-glow {
    opacity: 1;
  }

  .event-marker.is-highlighted .marker-label {
    fill: var(--color-accent);
    font-weight: 700;
  }

  .event-marker.is-highlighted.marker-top .marker-circle {
    fill: var(--color-accent);
    stroke: var(--color-accent-hover);
  }

  .event-marker.is-highlighted.marker-right .marker-circle {
    fill: var(--color-secondary);
    stroke: var(--color-secondary-hover);
  }

  .event-marker.is-highlighted.marker-bottom .marker-circle {
    fill: var(--color-earth-400);
    stroke: var(--color-text-muted);
  }

  .event-marker.is-highlighted.marker-left .marker-circle {
    fill: var(--color-text-muted);
    stroke: var(--color-text-secondary);
  }

  .event-marker.is-highlighted .marker-dot {
    fill: var(--color-surface);
  }

  /* ---- Dimming: when any marker is highlighted, dim the rest ---- */
  .workflow-svg.has-highlight .event-marker:not(.is-highlighted) {
    opacity: 0.35;
    transition: opacity var(--transition-base);
  }

  .workflow-svg.has-highlight .event-marker.is-highlighted {
    opacity: 1;
  }

  .workflow-svg.has-highlight .workflow-rect {
    stroke: var(--color-earth-200);
  }
</style>
