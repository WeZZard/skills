---
import Base from "../../../layouts/Base.astro";
import Breadcrumb from "../../../components/Breadcrumb.astro";
import SkillCard from "../../../components/SkillCard.astro";
import WorkflowDiagram from "../../../components/WorkflowDiagram.astro";
import { readdirSync, readFileSync, existsSync } from "fs";
import { join } from "path";

interface PluginData {
  sourceHash: string;
  generatedAt: string;
  plugin: {
    name: string;
    displayName: string;
    tagline: string;
    skillCount: number;
    skills: string[];
    marketplaceCommand: string;
    installCommand: string;
  };
}

interface SkillData {
  sourceHash: string;
  generatedAt: string;
  skill: {
    name: string;
    displayName: string;
    pluginName: string;
    tagline: string;
    shortSummary: string;
    fullSummary: string;
    highlights: Array<{ title: string; description: string }>;
    workflow: {
      steps: Array<{ name: string; description: string; details?: string }>;
    };
  };
}

export function getStaticPaths() {
  const pluginsDir = join(process.cwd(), "src/content/generated/plugins");
  if (!existsSync(pluginsDir)) return [];

  const files = readdirSync(pluginsDir).filter((f) => f.endsWith(".json"));
  return files.map((f) => {
    const content = readFileSync(join(pluginsDir, f), "utf-8");
    const data = JSON.parse(content) as PluginData;
    return {
      params: { plugin: data.plugin.name },
      props: { pluginData: data },
    };
  });
}

interface Props {
  pluginData: PluginData;
}

const { pluginData } = Astro.props;
const { plugin } = pluginData;

// Load skills for this plugin
const skillsDir = join(process.cwd(), "src/content/generated/skills");
let skills: SkillData[] = [];

if (existsSync(skillsDir)) {
  skills = plugin.skills
    .map((skillName) => {
      const skillPath = join(skillsDir, `${skillName}.json`);
      if (!existsSync(skillPath)) return null;
      const content = readFileSync(skillPath, "utf-8");
      return JSON.parse(content) as SkillData;
    })
    .filter((s): s is SkillData => s !== null);
}

const breadcrumbItems = [
  { label: "Home", href: "/" },
  { label: plugin.displayName },
];

// Load workflow diagram data
const workflowPath = join(process.cwd(), `src/content/generated/workflow/${plugin.name}.json`);
const workflowData = existsSync(workflowPath)
  ? JSON.parse(readFileSync(workflowPath, "utf-8"))
  : null;

// Sort skills by workflow skill_order if available
if (workflowData?.skillOrder) {
  const order: string[] = workflowData.skillOrder;
  skills.sort((a, b) => {
    const ai = order.indexOf(a.skill.name);
    const bi = order.indexOf(b.skill.name);
    // Skills in the order list come first; unlisted ones go to the end alphabetically
    if (ai === -1 && bi === -1) return a.skill.name.localeCompare(b.skill.name);
    if (ai === -1) return 1;
    if (bi === -1) return -1;
    return ai - bi;
  });
}
---

<Base title={plugin.displayName} description={plugin.tagline} showHeader={false}>
  <!-- Hero area: uses calculated padding to align at half of diagram rect offset -->
  <div class="hero-area">
    <div class="hero-area-inner">
      <Breadcrumb items={breadcrumbItems} />

      <!-- Hero Section: Title left, Commands right -->
      <section class="plugin-hero">
      <div class="hero-left">
        <h1 class="plugin-title">{plugin.displayName}</h1>
        <p class="plugin-tagline">{plugin.tagline}</p>
      </div>

      <div class="hero-right">
        <div class="install-label">Install in Claude Code</div>
        <div class="commands-stack">
          <div class="command-group">
            <span class="command-step">1</span>
            <div class="command-box">
              <code>{plugin.marketplaceCommand}</code>
              <button class="copy-btn" data-command={plugin.marketplaceCommand} aria-label="Copy marketplace command">
                <svg class="copy-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <svg class="check-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </button>
            </div>
          </div>

          <div class="command-group">
            <span class="command-step">2</span>
            <div class="command-box">
              <code>{plugin.installCommand}</code>
              <button class="copy-btn" data-command={plugin.installCommand} aria-label="Copy install command">
                <svg class="copy-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <svg class="check-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
    </div>
  </div>

  <!-- Regular container for content sections -->
  <div class="container">
    {workflowData && (
      <WorkflowDiagram diagramData={workflowData} />
    )}

    <!-- Skills Section -->
    <section class="skills-section">
      <header class="section-header">
        <h2>Skills</h2>
        <span class="skill-count">{skills.length} available</span>
      </header>

      <div class="skills-grid">
        {skills.map((s, index) => (
          <SkillCard
            name={s.skill.name}
            displayName={s.skill.displayName}
            pluginName={plugin.name}
            tagline={s.skill.tagline}
            index={index}
          />
        ))}
      </div>
    </section>

    <!-- Page Footer -->
    <footer class="page-footer">
      <span>Content generated {new Date(pluginData.generatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
    </footer>
  </div>
</Base>

<script>
  document.querySelectorAll(".copy-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const command = btn.getAttribute("data-command");
      if (command) {
        navigator.clipboard.writeText(command);
        btn.classList.add("copied");
        setTimeout(() => btn.classList.remove("copied"), 1500);
      }
    });
  });
</script>

<style>
  /* Hero Area — full-width wrapper with calculated padding
     so content aligns relative to the workflow diagram rect's left edge.

     Diagram rect left = container-margin + container-padding(24) + wrapper-padding(40)
     container-margin = (100vw - 1100px) / 2  (when viewport > 1100px)
     So diagram rect left = (100vw - 1100px) / 2 + 64px

     Strategy — two tiers based on the gap between title and diagram rect border:
       • Half-screen (~1280px): gap = half of diagram rect offset
         padding = (100vw - 1100px) / 4 + 32px  → 77px at 1280px
         gap = diagram_rect_left - padding = 77px
       • Full-screen / wide: gap doubles to 154px
         padding = (100vw - 1100px) / 2 - 90px  → 640px at 2560px
         gap = diagram_rect_left - padding = 154px
       The two formulas cross at 1588px. Using max() of both
       gives a smooth transition: the steeper formula takes over above 1588px.
  */
  .hero-area {
    width: 100%;
    border-bottom: 1px solid var(--color-border-subtle);
    margin-bottom: var(--space-16);
  }

  .hero-area-inner {
    /* Two-tier padding:
       Tier 1 (≤1588px): (100vw - 1100px) / 4 + 32px  — half diagram offset
       Tier 2 (>1588px):  (100vw - 1100px) / 2 - 90px  — doubled gap
       Floor of --space-6 (24px) for narrow viewports. */
    padding-left: max(var(--space-6), calc((100vw - 1100px) / 4 + 32px), calc((100vw - 1100px) / 2 - 90px));
    padding-right: max(var(--space-6), calc((100vw - 1100px) / 4 + 32px), calc((100vw - 1100px) / 2 - 90px));
  }

  /* Hero Section */
  .plugin-hero {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: var(--space-24);
    align-items: center;
    padding: var(--space-16) 0 var(--space-20);
  }

  .hero-left {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .plugin-title {
    font-family: var(--font-display);
    font-size: clamp(3rem, 8vw, 5rem);
    font-weight: 600;
    color: var(--color-text);
    line-height: 1.05;
    letter-spacing: -0.03em;
  }

  .plugin-tagline {
    font-size: var(--text-2xl);
    color: var(--color-text-muted);
    line-height: var(--leading-relaxed);
    max-width: 600px;
  }

  .hero-right {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    min-width: 340px;
  }

  .install-label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
  }

  .commands-stack {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .command-group {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .command-step {
    flex-shrink: 0;
    width: 22px;
    height: 22px;
    background: var(--color-accent-soft);
    color: var(--color-accent);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-xs);
    font-weight: 600;
  }

  .command-box {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    background: var(--color-earth-100);
    padding: var(--space-2) var(--space-3);
    padding-right: calc(var(--space-3) + 32px);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border-subtle);
  }

  .command-box code {
    flex: 1;
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-text);
    background: none;
    border: none;
    padding: 0;
    white-space: nowrap;
  }

  .copy-btn {
    position: absolute;
    right: var(--space-2);
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: var(--color-accent);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    color: white;
    transition: background var(--transition-fast);
  }

  .copy-btn:hover {
    background: var(--color-accent-hover);
  }

  .copy-btn .copy-icon,
  .copy-btn .check-icon {
    position: absolute;
    transition: opacity var(--transition-fast);
  }

  .copy-btn .check-icon {
    opacity: 0;
  }

  .copy-btn.copied .copy-icon {
    opacity: 0;
  }

  .copy-btn.copied .check-icon {
    opacity: 1;
  }

  /* Skills Section */
  .skills-section {
    margin-bottom: var(--space-12);
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .section-header h2 {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: 600;
    color: var(--color-text);
  }

  .skill-count {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    background: var(--color-earth-100);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
  }

  .skills-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-5);
  }

  /* Page Footer */
  .page-footer {
    text-align: center;
    padding: var(--space-8) 0;
    border-top: 1px solid var(--color-border);
    color: var(--color-text-light);
    font-size: var(--text-xs);
  }

  /* Desktop - larger hero spacing */
  @media (min-width: 901px) {
    .plugin-hero {
      padding: var(--space-24) 0 calc(var(--space-20) * 2);
    }
  }

  /* Responsive */
  @media (max-width: 900px) {
    .plugin-hero {
      grid-template-columns: 1fr;
      gap: var(--space-8);
    }

    .hero-right {
      min-width: unset;
    }
  }

  @media (max-width: 768px) {
    .hero-area {
      margin-bottom: var(--space-8);
    }

    .hero-area-inner {
      padding-left: var(--space-5);
      padding-right: var(--space-5);
    }

    .plugin-hero {
      padding: var(--space-6) 0 var(--space-8);
    }

    .plugin-title {
      font-size: var(--text-3xl);
    }

    .plugin-tagline {
      font-size: var(--text-lg);
    }

    .skills-grid {
      grid-template-columns: 1fr;
    }

    .command-group {
      flex-direction: column;
      align-items: stretch;
      gap: var(--space-2);
    }

    .command-step {
      align-self: flex-start;
    }

    .command-box {
      padding-right: calc(var(--space-3) + 36px);
    }

    .command-box code {
      font-size: var(--text-xs);
      white-space: normal;
      word-break: break-all;
    }
  }
</style>
