---
import Base from "../../../layouts/Base.astro";
import Breadcrumb from "../../../components/Breadcrumb.astro";
import SkillCard from "../../../components/SkillCard.astro";
import { readdirSync, readFileSync, existsSync } from "fs";
import { join } from "path";

interface PluginData {
  sourceHash: string;
  generatedAt: string;
  plugin: {
    name: string;
    displayName: string;
    tagline: string;
    shortDescription: string;
    fullDescription: string;
    useCases: Array<{ title: string; description: string }>;
    skillCount: number;
    skills: string[];
  };
}

interface SkillData {
  sourceHash: string;
  generatedAt: string;
  skill: {
    name: string;
    displayName: string;
    pluginName: string;
    tagline: string;
    shortSummary: string;
    fullSummary: string;
    highlights: Array<{ title: string; description: string }>;
    workflow: {
      steps: Array<{ name: string; description: string; details?: string }>;
    };
  };
}

export function getStaticPaths() {
  const pluginsDir = join(process.cwd(), "src/content/generated/plugins");
  if (!existsSync(pluginsDir)) return [];

  const files = readdirSync(pluginsDir).filter((f) => f.endsWith(".json"));
  return files.map((f) => {
    const content = readFileSync(join(pluginsDir, f), "utf-8");
    const data = JSON.parse(content) as PluginData;
    return {
      params: { plugin: data.plugin.name },
      props: { pluginData: data },
    };
  });
}

interface Props {
  pluginData: PluginData;
}

const { pluginData } = Astro.props;
const { plugin } = pluginData;

// Load skills for this plugin
const skillsDir = join(process.cwd(), "src/content/generated/skills");
let skills: SkillData[] = [];

if (existsSync(skillsDir)) {
  skills = plugin.skills
    .map((skillName) => {
      const skillPath = join(skillsDir, `${skillName}.json`);
      if (!existsSync(skillPath)) return null;
      const content = readFileSync(skillPath, "utf-8");
      return JSON.parse(content) as SkillData;
    })
    .filter((s): s is SkillData => s !== null);
}

const breadcrumbItems = [
  { label: "Home", href: "/" },
  { label: plugin.displayName },
];
---

<Base title={plugin.displayName} description={plugin.tagline} showHeader={false}>
  <div class="container-narrow">
    <!-- Breadcrumb -->
    <Breadcrumb items={breadcrumbItems} />

    <!-- Plugin Header -->
    <header class="plugin-header">
      <p class="plugin-eyebrow">Plugin</p>
      <h1>{plugin.displayName}</h1>
      <p class="plugin-tagline">{plugin.tagline}</p>
    </header>

    <!-- Description Section -->
    <section class="description-section">
      <p>{plugin.fullDescription}</p>
    </section>

    <!-- Use Cases Section -->
    {plugin.useCases && plugin.useCases.length > 0 && (
      <section class="usecases-section">
        <header class="section-title">
          <span class="section-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
              <polyline points="22 4 12 14.01 9 11.01" />
            </svg>
          </span>
          <h2>Use Cases</h2>
        </header>

        <div class="usecases-grid">
          {plugin.useCases.map((useCase, index) => (
            <article class="usecase-card" style={`--delay: ${index * 80}ms`}>
              <h3>{useCase.title}</h3>
              <p>{useCase.description}</p>
            </article>
          ))}
        </div>
      </section>
    )}

    <!-- Skills Section -->
    <section class="skills-section">
      <header class="section-title">
        <span class="section-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
          </svg>
        </span>
        <h2>Skills</h2>
        <span class="skill-count">{skills.length} available</span>
      </header>

      <div class="skills-grid">
        {skills.map((s, index) => (
          <SkillCard
            name={s.skill.name}
            displayName={s.skill.displayName}
            pluginName={plugin.name}
            tagline={s.skill.tagline}
            shortSummary={s.skill.shortSummary}
            index={index}
          />
        ))}
      </div>
    </section>

    <!-- Install CTA -->
    <section class="cta-section">
      <div class="cta-card">
        <div class="cta-content">
          <h2>Install This Plugin</h2>
          <p>Add the marketplace and install {plugin.displayName}</p>
        </div>
        <div class="cta-commands">
          <div class="command-box">
            <code>/plugin install wezzard@wezzard-skills</code>
            <button class="copy-btn" data-command="/plugin install wezzard@wezzard-skills">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              <span class="copy-text">Copy</span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Page Footer -->
    <footer class="page-footer">
      <span>Content generated {new Date(pluginData.generatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
    </footer>
  </div>
</Base>

<script>
  document.querySelectorAll(".copy-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const command = btn.getAttribute("data-command");
      if (command) {
        navigator.clipboard.writeText(command);
        const text = btn.querySelector(".copy-text");
        if (text) {
          text.textContent = "Copied!";
          setTimeout(() => (text.textContent = "Copy"), 1500);
        }
      }
    });
  });
</script>

<style>
  /* Plugin Header */
  .plugin-header {
    text-align: center;
    padding: var(--space-8) 0 var(--space-10);
    border-bottom: 1px solid var(--color-border-subtle);
    margin-bottom: var(--space-10);
  }

  .plugin-eyebrow {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-accent);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    margin-bottom: var(--space-3);
  }

  .plugin-header h1 {
    font-family: var(--font-display);
    font-size: var(--text-4xl);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-4);
    line-height: var(--leading-tight);
  }

  .plugin-tagline {
    font-size: var(--text-lg);
    color: var(--color-text-muted);
    max-width: 500px;
    margin: 0 auto;
    line-height: var(--leading-relaxed);
  }

  /* Description Section */
  .description-section {
    background: var(--color-bg-alt);
    padding: var(--space-8);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-12);
    border: 1px solid var(--color-border-subtle);
  }

  .description-section p {
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
    color: var(--color-text-secondary);
    text-align: center;
  }

  /* Section Title */
  .section-title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-6);
  }

  .section-icon {
    width: 40px;
    height: 40px;
    background: var(--color-accent-soft);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-accent);
  }

  .section-title h2 {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: 600;
    color: var(--color-text);
  }

  .skill-count {
    margin-left: auto;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    background: var(--color-earth-100);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
  }

  /* Use Cases Section */
  .usecases-section {
    margin-bottom: var(--space-12);
  }

  .usecases-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .usecase-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    animation: fadeIn 0.4s ease forwards;
    animation-delay: var(--delay);
    opacity: 0;
    transition: all var(--transition-base);
  }

  .usecase-card:hover {
    border-color: var(--color-secondary);
    box-shadow: var(--shadow-md);
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }

  .usecase-card h3 {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .usecase-card p {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    line-height: var(--leading-relaxed);
  }

  /* Skills Section */
  .skills-section {
    margin-bottom: var(--space-12);
  }

  .skills-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-5);
  }

  /* CTA Section */
  .cta-section {
    margin-bottom: var(--space-12);
  }

  .cta-card {
    background: linear-gradient(135deg, var(--color-accent-softer) 0%, var(--color-secondary-softer) 100%);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-6);
  }

  .cta-content h2 {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-1);
  }

  .cta-content p {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .command-box {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    background: var(--color-surface);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
  }

  .command-box code {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-text);
    background: none;
    border: none;
    padding: 0;
    font-weight: 500;
  }

  .copy-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    background: var(--color-accent);
    border: none;
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    cursor: pointer;
    color: white;
    font-size: var(--text-xs);
    font-weight: 500;
    transition: background var(--transition-fast);
    white-space: nowrap;
  }

  .copy-btn:hover {
    background: var(--color-accent-hover);
  }

  .copy-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Page Footer */
  .page-footer {
    text-align: center;
    padding: var(--space-8) 0;
    border-top: 1px solid var(--color-border);
    color: var(--color-text-light);
    font-size: var(--text-xs);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .plugin-header {
      padding: var(--space-6) 0 var(--space-8);
    }

    .plugin-header h1 {
      font-size: var(--text-3xl);
    }

    .plugin-tagline {
      font-size: var(--text-base);
    }

    .description-section {
      padding: var(--space-6);
    }

    .description-section p {
      font-size: var(--text-base);
    }

    .usecases-grid,
    .skills-grid {
      grid-template-columns: 1fr;
    }

    .cta-card {
      flex-direction: column;
      align-items: stretch;
      text-align: center;
      padding: var(--space-6);
    }

    .command-box {
      flex-direction: column;
      gap: var(--space-3);
    }

    .command-box code {
      font-size: var(--text-xs);
    }

    .copy-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
