---
import Base from "../../../layouts/Base.astro";
import Breadcrumb from "../../../components/Breadcrumb.astro";
import SkillCard from "../../../components/SkillCard.astro";
import WorkflowDiagram from "../../../components/WorkflowDiagram.astro";
import { loadPluginWebsiteConfig } from "../../../config/site";
import { readdirSync, readFileSync, existsSync } from "fs";
import { join } from "path";

interface PluginData {
  sourceHash: string;
  generatedAt: string;
  plugin: {
    name: string;
    displayName: string;
    tagline: string;
    shortDescription: string;
    fullDescription: string;
    useCases: Array<{ title: string; description: string }>;
    skillCount: number;
    skills: string[];
    marketplaceCommand: string;
    installCommand: string;
  };
}

interface SkillData {
  sourceHash: string;
  generatedAt: string;
  skill: {
    name: string;
    displayName: string;
    pluginName: string;
    tagline: string;
    shortSummary: string;
    fullSummary: string;
    highlights: Array<{ title: string; description: string }>;
    workflow: {
      steps: Array<{ name: string; description: string; details?: string }>;
    };
  };
}

export function getStaticPaths() {
  const pluginsDir = join(process.cwd(), "src/content/generated/plugins");
  if (!existsSync(pluginsDir)) return [];

  const files = readdirSync(pluginsDir).filter((f) => f.endsWith(".json"));
  return files.map((f) => {
    const content = readFileSync(join(pluginsDir, f), "utf-8");
    const data = JSON.parse(content) as PluginData;
    return {
      params: { plugin: data.plugin.name },
      props: { pluginData: data },
    };
  });
}

interface Props {
  pluginData: PluginData;
}

const { pluginData } = Astro.props;
const { plugin } = pluginData;

// Load skills for this plugin
const skillsDir = join(process.cwd(), "src/content/generated/skills");
let skills: SkillData[] = [];

if (existsSync(skillsDir)) {
  skills = plugin.skills
    .map((skillName) => {
      const skillPath = join(skillsDir, `${skillName}.json`);
      if (!existsSync(skillPath)) return null;
      const content = readFileSync(skillPath, "utf-8");
      return JSON.parse(content) as SkillData;
    })
    .filter((s): s is SkillData => s !== null);
}

const breadcrumbItems = [
  { label: "Home", href: "/" },
  { label: plugin.displayName },
];

// Get plugin-specific content from TOML config
const websiteConfig = loadPluginWebsiteConfig(plugin.name);

// Load workflow diagram data
const workflowPath = join(process.cwd(), `src/content/generated/workflow/${plugin.name}.json`);
const workflowData = existsSync(workflowPath)
  ? JSON.parse(readFileSync(workflowPath, "utf-8"))
  : null;
---

<Base title={plugin.displayName} description={plugin.tagline} showHeader={false}>
  <!-- Regular container for breadcrumb -->
  <div class="container">
    <Breadcrumb items={breadcrumbItems} />
  </div>

  <!-- Wide container for hero -->
  <div class="container-wide">
    <!-- Hero Section: Title left, Commands right -->
    <section class="plugin-hero">
      <div class="hero-left">
        <h1 class="plugin-title">{plugin.displayName}</h1>
        <p class="plugin-tagline">{plugin.tagline}</p>
      </div>

      <div class="hero-right">
        <div class="install-label">Install in Claude Code</div>
        <div class="commands-stack">
          <div class="command-group">
            <span class="command-step">1</span>
            <div class="command-box">
              <code>{plugin.marketplaceCommand}</code>
              <button class="copy-btn" data-command={plugin.marketplaceCommand} aria-label="Copy marketplace command">
                <svg class="copy-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <svg class="check-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </button>
            </div>
          </div>

          <div class="command-group">
            <span class="command-step">2</span>
            <div class="command-box">
              <code>{plugin.installCommand}</code>
              <button class="copy-btn" data-command={plugin.installCommand} aria-label="Copy install command">
                <svg class="copy-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <svg class="check-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Regular container for content sections -->
  <div class="container">
    {workflowData ? (
      <WorkflowDiagram diagramData={workflowData} />
    ) : websiteConfig?.philosophy && (
      <section class="philosophy-section">
        <header class="philosophy-header">
          <h2 class="philosophy-title">Design Philosophy</h2>
          <p class="philosophy-intro">{websiteConfig.philosophy.intro}</p>
        </header>

        <div class="philosophy-grid">
          {websiteConfig.philosophy.sections.map((section, index) => (
            <article class="philosophy-card" style={`--delay: ${index * 80}ms`}>
              <h3>{section.title}</h3>
              <p>{section.content}</p>
            </article>
          ))}
        </div>
      </section>
    )}

    <!-- Skills Section -->
    <section class="skills-section">
      <header class="section-header">
        <h2>Skills</h2>
        <span class="skill-count">{skills.length} available</span>
      </header>

      <div class="skills-grid">
        {skills.map((s, index) => (
          <SkillCard
            name={s.skill.name}
            displayName={s.skill.displayName}
            pluginName={plugin.name}
            tagline={s.skill.tagline}
            shortSummary={s.skill.shortSummary}
            index={index}
          />
        ))}
      </div>
    </section>

    <!-- Page Footer -->
    <footer class="page-footer">
      <span>Content generated {new Date(pluginData.generatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
    </footer>
  </div>
</Base>

<script>
  document.querySelectorAll(".copy-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const command = btn.getAttribute("data-command");
      if (command) {
        navigator.clipboard.writeText(command);
        btn.classList.add("copied");
        setTimeout(() => btn.classList.remove("copied"), 1500);
      }
    });
  });
</script>

<style>
  /* Hero Section */
  .plugin-hero {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: var(--space-20);
    align-items: center;
    padding: var(--space-16) 0 var(--space-20);
    border-bottom: 1px solid var(--color-border-subtle);
    margin-bottom: var(--space-16);
  }

  .hero-left {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .plugin-title {
    font-family: var(--font-display);
    font-size: clamp(3rem, 8vw, 5rem);
    font-weight: 600;
    color: var(--color-text);
    line-height: 1.05;
    letter-spacing: -0.03em;
  }

  .plugin-tagline {
    font-size: var(--text-2xl);
    color: var(--color-text-muted);
    line-height: var(--leading-relaxed);
    max-width: 600px;
  }

  .hero-right {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    min-width: 380px;
  }

  .install-label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
  }

  .commands-stack {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .command-group {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .command-step {
    flex-shrink: 0;
    width: 22px;
    height: 22px;
    background: var(--color-accent-soft);
    color: var(--color-accent);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-xs);
    font-weight: 600;
  }

  .command-box {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    background: var(--color-earth-100);
    padding: var(--space-2) var(--space-3);
    padding-right: calc(var(--space-3) + 32px);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border-subtle);
  }

  .command-box code {
    flex: 1;
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-text);
    background: none;
    border: none;
    padding: 0;
    white-space: nowrap;
  }

  .copy-btn {
    position: absolute;
    right: var(--space-2);
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: var(--color-accent);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    color: white;
    transition: background var(--transition-fast);
  }

  .copy-btn:hover {
    background: var(--color-accent-hover);
  }

  .copy-btn .copy-icon,
  .copy-btn .check-icon {
    position: absolute;
    transition: opacity var(--transition-fast);
  }

  .copy-btn .check-icon {
    opacity: 0;
  }

  .copy-btn.copied .copy-icon {
    opacity: 0;
  }

  .copy-btn.copied .check-icon {
    opacity: 1;
  }

  /* Philosophy Section */
  .philosophy-section {
    margin-bottom: var(--space-16);
  }

  .philosophy-header {
    /* Align with card content by adding same padding as cards */
    padding-left: var(--space-6);
    margin-bottom: var(--space-8);
  }

  .philosophy-title {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-4);
  }

  .philosophy-intro {
    font-size: var(--text-xl);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
  }

  .philosophy-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-6);
  }

  .philosophy-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    animation: fadeIn 0.4s ease forwards;
    animation-delay: var(--delay);
    opacity: 0;
    transition: border-color var(--transition-base), box-shadow var(--transition-base);
  }

  .philosophy-card:hover {
    border-color: var(--color-accent);
    box-shadow: var(--shadow-md);
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }

  .philosophy-card h3 {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-3);
  }

  .philosophy-card p {
    font-size: var(--text-base);
    color: var(--color-text-muted);
    line-height: var(--leading-relaxed);
  }

  /* Skills Section */
  .skills-section {
    margin-bottom: var(--space-12);
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .section-header h2 {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: 600;
    color: var(--color-text);
  }

  .skill-count {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    background: var(--color-earth-100);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
  }

  .skills-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-5);
  }

  /* Page Footer */
  .page-footer {
    text-align: center;
    padding: var(--space-8) 0;
    border-top: 1px solid var(--color-border);
    color: var(--color-text-light);
    font-size: var(--text-xs);
  }

  /* Desktop - larger hero spacing */
  @media (min-width: 901px) {
    .plugin-hero {
      padding: var(--space-24) 0 calc(var(--space-20) * 2);
    }
  }

  /* Responsive */
  @media (max-width: 900px) {
    .plugin-hero {
      grid-template-columns: 1fr;
      gap: var(--space-8);
    }

    .hero-right {
      min-width: unset;
    }

    .philosophy-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .plugin-hero {
      padding: var(--space-6) 0 var(--space-8);
    }

    .plugin-title {
      font-size: var(--text-3xl);
    }

    .plugin-tagline {
      font-size: var(--text-lg);
    }

    .skills-grid {
      grid-template-columns: 1fr;
    }

    .command-group {
      flex-direction: column;
      align-items: stretch;
      gap: var(--space-2);
    }

    .command-step {
      align-self: flex-start;
    }

    .command-box {
      padding-right: calc(var(--space-3) + 36px);
    }

    .command-box code {
      font-size: var(--text-xs);
      white-space: normal;
      word-break: break-all;
    }
  }
</style>
