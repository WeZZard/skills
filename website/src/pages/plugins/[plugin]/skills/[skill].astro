---
import Base from "../../../../layouts/Base.astro";
import Breadcrumb from "../../../../components/Breadcrumb.astro";
import HighlightCard from "../../../../components/HighlightCard.astro";
import WorkflowStep from "../../../../components/WorkflowStep.astro";
import { readdirSync, readFileSync, existsSync } from "fs";
import { join } from "path";

interface PluginData {
  sourceHash: string;
  generatedAt: string;
  plugin: {
    name: string;
    displayName: string;
    tagline: string;
    skillCount: number;
    skills: string[];
  };
}

interface SkillData {
  sourceHash: string;
  generatedAt: string;
  skill: {
    name: string;
    displayName: string;
    pluginName: string;
    tagline: string;
    shortSummary: string;
    fullSummary: string;
    highlights: Array<{ title: string; description: string }>;
    workflow: {
      steps: Array<{ name: string; description: string; details?: string }>;
    };
  };
}

export function getStaticPaths() {
  const pluginsDir = join(process.cwd(), "src/content/generated/plugins");
  const skillsDir = join(process.cwd(), "src/content/generated/skills");

  if (!existsSync(pluginsDir) || !existsSync(skillsDir)) return [];

  const paths: Array<{
    params: { plugin: string; skill: string };
    props: { skillData: SkillData; pluginData: PluginData };
  }> = [];

  // Load all plugins
  const pluginFiles = readdirSync(pluginsDir).filter((f) => f.endsWith(".json"));

  for (const pluginFile of pluginFiles) {
    const pluginContent = readFileSync(join(pluginsDir, pluginFile), "utf-8");
    const pluginData = JSON.parse(pluginContent) as PluginData;

    // Load skills for this plugin
    for (const skillName of pluginData.plugin.skills) {
      const skillPath = join(skillsDir, `${skillName}.json`);
      if (!existsSync(skillPath)) continue;

      const skillContent = readFileSync(skillPath, "utf-8");
      const skillData = JSON.parse(skillContent) as SkillData;

      paths.push({
        params: {
          plugin: pluginData.plugin.name,
          skill: skillData.skill.name
        },
        props: { skillData, pluginData },
      });
    }
  }

  return paths;
}

interface Props {
  skillData: SkillData;
  pluginData: PluginData;
}

const { skillData, pluginData } = Astro.props;
const { skill } = skillData;
const { plugin } = pluginData;

const breadcrumbItems = [
  { label: "Home", href: "/" },
  { label: plugin.displayName, href: `/plugins/${plugin.name}` },
  { label: skill.displayName },
];
---

<Base title={skill.displayName} description={skill.tagline} showHeader={false}>
  <div class="container-narrow">
    <!-- Breadcrumb -->
    <Breadcrumb items={breadcrumbItems} />

    <!-- Skill Header -->
    <header class="skill-header">
      <p class="skill-eyebrow">Skill</p>
      <h1>{skill.displayName}</h1>
      <p class="skill-tagline">{skill.tagline}</p>
    </header>

    <!-- Summary Section -->
    <section class="summary-section">
      <p>{skill.fullSummary}</p>
    </section>

    <!-- Highlights Section -->
    {skill.highlights && skill.highlights.length > 0 && (
      <section class="highlights-section">
        <header class="section-title">
          <span class="section-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
            </svg>
          </span>
          <h2>Key Highlights</h2>
        </header>

        <div class="highlights-grid">
          {skill.highlights.map((highlight, index) => (
            <HighlightCard
              title={highlight.title}
              description={highlight.description}
              index={index}
            />
          ))}
        </div>
      </section>
    )}

    <!-- Workflow Section -->
    {skill.workflow && skill.workflow.steps && skill.workflow.steps.length > 0 && (
      <section class="workflow-section">
        <header class="section-title">
          <span class="section-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <polyline points="12 6 12 12 16 14" />
            </svg>
          </span>
          <h2>How It Works</h2>
        </header>

        <div class="workflow-steps">
          {skill.workflow.steps.map((step, index) => (
            <WorkflowStep
              stepNumber={index + 1}
              name={step.name}
              description={step.description}
              details={step.details}
              isLast={index === skill.workflow.steps.length - 1}
            />
          ))}
        </div>
      </section>
    )}

    <!-- Use This Skill CTA -->
    <section class="cta-section">
      <div class="cta-card">
        <div class="cta-content">
          <h2>Use This Skill</h2>
          <p>Run this command in Claude Code to activate the skill</p>
        </div>
        <div class="command-box">
          <code>/{plugin.name}:{skill.name}</code>
          <button class="copy-btn" data-command={`/${plugin.name}:${skill.name}`}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Page Footer -->
    <footer class="page-footer">
      <span>Content generated {new Date(skillData.generatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
    </footer>
  </div>
</Base>

<script>
  document.querySelectorAll(".copy-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const command = btn.getAttribute("data-command");
      if (command) {
        navigator.clipboard.writeText(command);
        const text = btn.querySelector(".copy-text");
        if (text) {
          text.textContent = "Copied!";
          setTimeout(() => (text.textContent = "Copy"), 1500);
        }
      }
    });
  });
</script>

<style>
  /* Skill Header */
  .skill-header {
    text-align: center;
    padding: var(--space-8) 0 var(--space-10);
    border-bottom: 1px solid var(--color-border-subtle);
    margin-bottom: var(--space-10);
  }

  .skill-eyebrow {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-accent);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    margin-bottom: var(--space-3);
  }

  .skill-header h1 {
    font-family: var(--font-display);
    font-size: var(--text-4xl);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-4);
    line-height: var(--leading-tight);
  }

  .skill-tagline {
    font-size: var(--text-lg);
    color: var(--color-text-muted);
    max-width: 500px;
    margin: 0 auto;
    line-height: var(--leading-relaxed);
  }

  /* Summary Section */
  .summary-section {
    background: var(--color-bg-alt);
    padding: var(--space-8);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-12);
    border: 1px solid var(--color-border-subtle);
  }

  .summary-section p {
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
    color: var(--color-text-secondary);
    text-align: center;
  }

  /* Section Title */
  .section-title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-6);
  }

  .section-icon {
    width: 40px;
    height: 40px;
    background: var(--color-accent-soft);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-accent);
  }

  .section-title h2 {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: 600;
    color: var(--color-text);
  }

  /* Highlights Section */
  .highlights-section {
    margin-bottom: var(--space-12);
  }

  .highlights-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  /* Workflow Section */
  .workflow-section {
    margin-bottom: var(--space-12);
  }

  .workflow-steps {
    display: flex;
    flex-direction: column;
  }

  /* CTA Section */
  .cta-section {
    margin-bottom: var(--space-12);
  }

  .cta-card {
    background: linear-gradient(135deg, var(--color-accent-softer) 0%, var(--color-secondary-softer) 100%);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-6);
  }

  .cta-content h2 {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-1);
  }

  .cta-content p {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .command-box {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    background: var(--color-surface);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
  }

  .command-box code {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-text);
    background: none;
    border: none;
    padding: 0;
    font-weight: 500;
  }

  .copy-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    background: var(--color-accent);
    border: none;
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    cursor: pointer;
    color: white;
    font-size: var(--text-xs);
    font-weight: 500;
    transition: background var(--transition-fast);
    white-space: nowrap;
  }

  .copy-btn:hover {
    background: var(--color-accent-hover);
  }

  .copy-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Page Footer */
  .page-footer {
    text-align: center;
    padding: var(--space-8) 0;
    border-top: 1px solid var(--color-border);
    color: var(--color-text-light);
    font-size: var(--text-xs);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .skill-header {
      padding: var(--space-6) 0 var(--space-8);
    }

    .skill-header h1 {
      font-size: var(--text-3xl);
    }

    .skill-tagline {
      font-size: var(--text-base);
    }

    .summary-section {
      padding: var(--space-6);
    }

    .summary-section p {
      font-size: var(--text-base);
    }

    .highlights-grid {
      grid-template-columns: 1fr;
    }

    .cta-card {
      flex-direction: column;
      align-items: stretch;
      text-align: center;
      padding: var(--space-6);
    }

    .command-box {
      flex-direction: column;
      gap: var(--space-3);
    }

    .command-box code {
      font-size: var(--text-xs);
    }

    .copy-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
