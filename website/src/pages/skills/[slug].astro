---
import Base from "../../layouts/Base.astro";
import { readdirSync, readFileSync, existsSync } from "fs";
import { join } from "path";

interface SkillData {
  sourceHash: string;
  generatedAt: string;
  skill: {
    name: string;
    tagline: string;
    summary: string;
    workflow: {
      mermaid: string;
      steps: Array<{ name: string; description: string }>;
    };
    principles: string[];
  };
}

export function getStaticPaths() {
  const generatedDir = join(process.cwd(), "src/content/generated");
  if (!existsSync(generatedDir)) return [];

  const files = readdirSync(generatedDir).filter((f) => f.endsWith(".json"));
  return files.map((f) => {
    const content = readFileSync(join(generatedDir, f), "utf-8");
    const data = JSON.parse(content) as SkillData;
    return {
      params: { slug: data.skill.name },
      props: { data },
    };
  });
}

interface Props {
  data: SkillData;
}

const { data } = Astro.props;
const { skill } = data;
---

<Base title={skill.name} description={skill.tagline}>
  <div class="page-bg"></div>

  <div class="container">
    <nav class="back-nav">
      <a href="/">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
        All skills
      </a>
    </nav>

    <header class="skill-header">
      <p class="skill-eyebrow">Skill</p>
      <h1>{skill.name}</h1>
      <p class="tagline">{skill.tagline}</p>
    </header>

    <section class="summary-section">
      <p>{skill.summary}</p>
    </section>

    <section class="workflow-section">
      <div class="section-title">
        <span class="section-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12 6 12 12 16 14" />
          </svg>
        </span>
        <h2>Workflow</h2>
      </div>

      <div class="mermaid-container">
        <pre class="mermaid">{skill.workflow.mermaid}</pre>
      </div>

      <div class="steps-list">
        {
          skill.workflow.steps.map((step, i) => (
            <div class="step-item">
              <span class="step-number">{i + 1}</span>
              <div class="step-content">
                <strong>{step.name}</strong>
                <span>{step.description}</span>
              </div>
            </div>
          ))
        }
      </div>
    </section>

    {
      skill.principles.length > 0 && (
        <section class="principles-section">
          <div class="section-title">
            <span class="section-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
            </span>
            <h2>Key Principles</h2>
          </div>
          <ul class="principles-list">
            {skill.principles.map((p) => (
              <li>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12" />
                </svg>
                <span>{p}</span>
              </li>
            ))}
          </ul>
        </section>
      )
    }

    <section class="use-section">
      <div class="use-card">
        <div class="use-content">
          <h2>Use this skill</h2>
          <p>Run this command in Claude Code to activate the skill</p>
        </div>
        <div class="command-box">
          <code>/intelligence-scale:{skill.name}</code>
          <button class="copy-btn" data-command={`/intelligence-scale:${skill.name}`}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
          </button>
        </div>
      </div>
    </section>

    <footer class="page-footer">
      <span>Content generated {new Date(data.generatedAt).toLocaleDateString()}</span>
    </footer>
  </div>
</Base>

<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: "base",
    themeVariables: {
      primaryColor: "rgba(16, 163, 127, 0.1)",
      primaryTextColor: "#171717",
      primaryBorderColor: "rgba(16, 163, 127, 0.3)",
      lineColor: "#a3a3a3",
      secondaryColor: "#fafafa",
      tertiaryColor: "#ffffff",
      background: "#ffffff",
      mainBkg: "#ffffff",
      nodeBorder: "rgba(16, 163, 127, 0.3)",
      clusterBkg: "rgba(16, 163, 127, 0.03)",
      fontSize: "14px",
    },
  });

  document.querySelectorAll(".copy-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const command = btn.getAttribute("data-command");
      navigator.clipboard.writeText(command);
      const text = btn.querySelector(".copy-text");
      text.textContent = "Copied!";
      setTimeout(() => (text.textContent = "Copy"), 1500);
    });
  });
</script>

<style>
  .page-bg {
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 40% at 30% 10%, rgba(16, 163, 127, 0.06), transparent),
      radial-gradient(ellipse 50% 30% at 70% 80%, rgba(99, 102, 241, 0.03), transparent);
    pointer-events: none;
    z-index: -1;
  }

  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
    position: relative;
  }

  .back-nav {
    margin-bottom: 3rem;
  }

  .back-nav a {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    font-weight: 500;
    transition: color 0.15s ease;
  }

  .back-nav a:hover {
    color: var(--color-accent);
    opacity: 1;
  }

  .skill-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .skill-eyebrow {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--color-accent);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 1rem;
  }

  .skill-header h1 {
    font-size: 2.75rem;
    margin-bottom: 1rem;
  }

  .skill-header .tagline {
    font-size: 1.125rem;
    color: var(--color-text-muted);
    max-width: 500px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .summary-section {
    background: var(--color-surface);
    padding: 2rem 2.5rem;
    border-radius: 20px;
    margin-bottom: 3rem;
    border: 1px solid var(--color-border);
  }

  .summary-section p {
    font-size: 1.05rem;
    line-height: 1.75;
    color: var(--color-text-secondary);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .section-icon {
    width: 36px;
    height: 36px;
    background: var(--color-accent-softer);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-accent);
  }

  .section-title h2 {
    font-size: 1.25rem;
  }

  .workflow-section,
  .principles-section {
    margin-bottom: 3rem;
  }

  .mermaid-container {
    background: var(--color-surface-elevated);
    padding: 2rem;
    border-radius: 16px;
    margin-bottom: 1.5rem;
    border: 1px solid var(--color-border);
    overflow-x: auto;
  }

  .mermaid-container .mermaid {
    background: none;
    border: none;
    padding: 0;
  }

  .steps-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .step-item {
    display: flex;
    gap: 1rem;
    padding: 1.25rem 1.5rem;
    background: var(--color-surface-elevated);
    border: 1px solid var(--color-border);
    border-radius: 14px;
    transition: all 0.15s ease;
  }

  .step-item:hover {
    border-color: var(--color-accent);
    box-shadow: var(--shadow-sm);
  }

  .step-number {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    background: var(--color-accent);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .step-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .step-content strong {
    font-weight: 600;
    color: var(--color-text);
  }

  .step-content span {
    color: var(--color-text-muted);
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .principles-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
  }

  .principles-list li {
    display: flex;
    align-items: flex-start;
    gap: 0.875rem;
    padding: 1rem 1.25rem;
    background: var(--color-surface-elevated);
    border-radius: 12px;
    border: 1px solid var(--color-border);
    font-size: 0.95rem;
    line-height: 1.5;
  }

  .principles-list li svg {
    flex-shrink: 0;
    color: var(--color-accent);
    margin-top: 0.125rem;
  }

  .principles-list li span {
    color: var(--color-text-secondary);
  }

  .use-section {
    margin-bottom: 3rem;
  }

  .use-card {
    background: linear-gradient(135deg, rgba(16, 163, 127, 0.08) 0%, rgba(16, 163, 127, 0.03) 100%);
    border: 1px solid rgba(16, 163, 127, 0.15);
    border-radius: 20px;
    padding: 2rem 2.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 2rem;
  }

  @media (max-width: 640px) {
    .use-card {
      flex-direction: column;
      align-items: stretch;
    }
  }

  .use-content h2 {
    font-size: 1.125rem;
    margin-bottom: 0.25rem;
    color: var(--color-text);
  }

  .use-content p {
    font-size: 0.9rem;
    color: var(--color-text-muted);
  }

  .command-box {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--color-surface-elevated);
    padding: 0.75rem 1rem;
    border-radius: 12px;
    border: 1px solid var(--color-border);
  }

  .command-box code {
    font-size: 0.95rem;
    background: none;
    border: none;
    padding: 0;
    color: var(--color-text);
    font-weight: 500;
  }

  .copy-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    background: var(--color-accent);
    border: none;
    padding: 0.5rem 0.875rem;
    border-radius: 8px;
    cursor: pointer;
    color: white;
    font-size: 0.8rem;
    font-weight: 500;
    transition: opacity 0.15s ease;
  }

  .copy-btn:hover {
    opacity: 0.9;
  }

  .copy-btn svg {
    width: 14px;
    height: 14px;
  }

  .page-footer {
    text-align: center;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
    color: var(--color-text-light);
    font-size: 0.8rem;
  }
</style>
